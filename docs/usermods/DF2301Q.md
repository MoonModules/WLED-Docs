# DF2301Q Voice Control Usermod

Voice control for WLED using the DFRobot DF2301Q offline voice recognition module.

## Hardware Requirements

- **DF2301Q Voice Recognition Module** [DFRobot SKU: SEN0539](https://www.dfrobot.com/product-2665.html)
- I2C connection to your ESP32/ESP8266

## Wiring

Connect the DF2301Q to your board's I2C bus:

| DF2301Q | ESP Board |
|---------|-----------|
| VCC     | 3.3V or 5V |
| GND     | GND       |
| SDA (or D/T)    | I2C SDA   |
| SCL (or C/R)     | I2C SCL   |

Configure your global I2C pins in WLED's LED Preferences before enabling this usermod.

## Usage

1. Say **"Hello Robot"** (or your custom wake word) to wake the module
2. Give a voice command within the wake time window
3. Each recognized command resets the wake timer, allowing multiple commands in sequence
4. If you want this to work with "Sync" for controlling all your WLED devices, enable "Send notifications on button press or IR" in the Sync menu.

## Configuration

All settings are available in WLED's Config > Usermods > DF2301Q section.

### General Settings

| Setting | Default | Description |
|---------|---------|-------------|
| Enabled | Off | Enable/disable the usermod |
| Volume | 10 | Speaker volume (0-20, higher values may distort) |
| Wake Time | 20 | Seconds the module listens after wake word |
| Poll Interval | 50 | Milliseconds between voice command checks |
| Startup Sound | 2 | Phrase spoken when WLED starts (0=disabled, 1="Yes, I'm here", 2="How can I help?") |

NOTE: If your startup sound is 1, the module will start in listening mode until it times out.

### Command Mappings

Map DF2301Q voice commands to WLED actions. Set to 0 to disable any mapping.

| Setting | Default | Default Phrase |
|---------|---------|----------------|
| Power On | 103 | "Turn on the light" |
| Power Off | 104 | "Turn off the light" |
| Brightness Up | 105 | "Brighten the light" |
| Brightness Down | 106 | "Dim the light" |
| Next Preset | 95 | "The next track" |
| Previous Preset | 94 | "The last track" |
| Next Effect | 0 | Disabled |
| Previous Effect | 0 | Disabled |

### Feature Toggles

| Setting | Default | Description |
|---------|---------|-------------|
| Numbered Presets | Off | Enable "Display number [0-9]" commands for presets 1-10 |
| Color Commands | Off | Enable "Set to [color]" commands for solid colors |
| Voice Feedback | Off | Module speaks back the recognized command |

NOTE: Numbered presets are 1..9 and 0 is mapped to 10 as we don't allow "0" as a preset number.

## Voice Commands Reference

### Default Built-in Commands (Always Available)

| Command ID | Voice Phrase |
|------------|--------------|
| 1 | "Hello Robot" (default wake word) |
| 2 | Custom wake word |
| 103 | "Turn on the light" |
| 104 | "Turn off the light" |
| 105 | "Brighten the light" |
| 106 | "Dim the light" |
| 107 | "Adjust brightness to maximum" |
| 108 | "Adjust brightness to minimum" |
| 94 | "The last track" |
| 95 | "The next track" |

### Numbered Presets (When Enabled)

| Command ID | Voice Phrase | WLED Preset |
|------------|--------------|-------------|
| 53 | "Display number one" | Preset 1 |
| 54 | "Display number two" | Preset 2 |
| 55 | "Display number three" | Preset 3 |
| 56 | "Display number four" | Preset 4 |
| 57 | "Display number five" | Preset 5 |
| 58 | "Display number six" | Preset 6 |
| 59 | "Display number seven" | Preset 7 |
| 60 | "Display number eight" | Preset 8 |
| 61 | "Display number nine" | Preset 9 |
| 52 | "Display number zero" | Preset 10 |

### Solid Color Commands (When Enabled)

These will set every LED to this color. 

| Command ID | Voice Phrase | Color |
|------------|--------------|-------|
| 116 | "Set to red" | Red |
| 117 | "Set to orange" | Orange |
| 118 | "Set to yellow" | Yellow |
| 119 | "Set to green" | Green |
| 120 | "Set to cyan" | Cyan |
| 121 | "Set to blue" | Blue |
| 122 | "Set to purple" | Purple |
| 123 | "Set to white" | White |

NOTE: You can edit the usermod to fill in more of the preset commands, but at some point it's too big for the JSON buffer and will fail to setup the usermod page.

### Custom Commands

The DF2301Q supports custom voice commands (IDs 5-21) that can be trained using the DFRobot Voice Configuration Tool. Map these to any WLED action using the command mapping settings.

| Command ID | Slot |
|------------|------|
| 5-21 | Custom Commands 1-17 |

NOTE: Learn how to train your custom wake-phrase and custom commands here: [Command Words and Training](https://wiki.dfrobot.com/SKU_SEN0539-EN_Gravity_Voice_Recognition_Module_I2C_UART#Command%20Words)

## Hot-Plug Support

The usermod includes automatic recovery for disconnected modules:

- If the module is not detected at startup, it will retry every 5 seconds
- If the module disconnects during operation, it will automatically reconnect when available
- No reboot required for hot-plug scenarios

## Status Display

The WLED Info page shows:

- Module detection status
- Last received command ID
- Current volume and wake time settings

## Compilation

Add to your `platformio_override.ini`:

```ini
[env:your_env]
extends = env:esp32dev
build_flags = ${env:esp32dev.build_flags}
  -D USERMOD_VOICE_CONTROL
```

Or include in your `my_config.h` file with:

```cpp
#define USERMOD_VOICE_CONTROL
```

## Troubleshooting

### Module Not Detected

1. Ensure the module is in **I2C mode** via the switch on the module.
2. Verify I2C pins are configured in WLED's LED Preferences
3. Check wiring connections
4. Ensure the module is powered (3.3V and 5V tolerant)
5. Check serial output (if available) for error messages

### Commands Not Recognized

1. Speak clearly and at a normal pace
2. Ensure you've said the wake word first
3. Check that the command mapping isn't set to 0 (disabled)
4. Increase wake time if commands timeout too quickly

### No Audio Output

1. Check speaker connection to the DF2301Q module and the speaker switch, depending on the board version.
2. Increase volume setting (default is 10)
3. Enable Voice Feedback option to test audio

### My Google Home/Alexa/Home Assistant is answering too!

1. Change your custom wake-phrase to something not close to your other devices.
2. Disable "no wake word needed" on those devices. Some answer to "turn off the lights" without a wake-phrase if enabled, for example.

## License

Licensed under the EUPL-1.2 or later.

## Credits

- Developed for MoonModules WLED by @TroyHacks
- Uses a stripped down version of the DFRobot DF2301Q library
